<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EduMentor</title>
    <!-- Bootstrap CSS for consistent styling across pages -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
    /* Small navbar tweaks */
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 1rem; background:#fff; border-bottom:1px solid #eee; }
    .navbar a.brand { font-weight:700; font-size:1.1rem; color:#007bff; text-decoration:none; }
    .nav-list { list-style:none; margin:0; padding:0; display:flex; gap:0.5rem; align-items:center; }
    .nav-list li a { text-decoration:none; color:#333; padding:0.45rem 0.75rem; border-radius:6px; display:inline-block; }
    .nav-list li a.active, .nav-list li a:hover { background:#f0f8ff; color:#007bff; }
    .nav-welcome { margin-left:0.75rem; color:#555; font-size:0.95rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div>
            <a class="brand" href="/">EduMentor</a>
        </div>

        <ul id="navLinks" class="nav-list">
            <!-- Navigation links populated by JS for auth-aware behavior -->
            <!-- Default static fallback for no-JS -->
            <li><a href="/" id="nav-home">Home</a></li>
            <li><a href="/login" id="nav-login">Login</a></li>
        </ul>
    </nav>

    <main class="container my-4">
        {% block content %}{% endblock %}
    </main>

    <footer class="site-footer text-center py-4">
        <p>© 2025 EduMentor. All rights reserved. · <a href="/privacy">Privacy Policy</a> · <a href="/terms">Terms of Service</a></p>
    </footer>

    <!-- Bootstrap JS (Popper included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="" crossorigin="anonymous"></script>

    <script>
    // Dynamic navigation: shows appropriate links depending on auth state.
    (function(){
      const navLinksEl = document.getElementById('navLinks');

      function setActive() {
        const path = window.location.pathname.replace(/\/+$/, '') || '/';
        Array.from(navLinksEl.querySelectorAll('a')).forEach(a=>{
          // Compare path segments
          const href = a.getAttribute('href') || '';
          const normalized = href.replace(/\/+$/, '') || '/';
          if (normalized === path) a.classList.add('active'); else a.classList.remove('active');
        });
      }

      function buildNav(user) {
        // user: null or object {name, email, ...}
        const isAuth = !!user;
        const items = [];

        items.push({ href: '/', text: 'Home' });
        if (isAuth) {
          items.push({ href: '/dashboard', text: 'Dashboard' });
          items.push({ href: '/learn', text: 'Learn' });
          items.push({ href: '/analytics', text: 'Analytics' });
          items.push({ href: '/export-data', text: 'Export Data' });
          items.push({ href: '/subscription', text: 'Plans' });
          items.push({ href: '/settings', text: 'Settings' });
          items.push({ href: '#logout', text: 'Logout', id: 'nav-logout' });
        } else {
          items.push({ href: '/login', text: 'Login' });
          items.push({ href: '/register', text: 'Register' });
        }

        // Render links
        navLinksEl.innerHTML = items.map(it => {
          const idAttr = it.id ? ` id="${it.id}"` : '';
          return `<li><a href="${it.href}"${idAttr}>${it.text}</a></li>`;
        }).join('');

        // optionally show welcome name
        if (isAuth && user.name) {
          const welcome = document.createElement('li');
          welcome.className = 'nav-welcome';
          welcome.innerHTML = `<span class="nav-welcome">Welcome, ${user.name}</span>`;
          navLinksEl.appendChild(welcome);
        }

        // attach logout handler
        const logoutLink = document.getElementById('nav-logout');
        if (logoutLink) {
          logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            // Clear client tokens and redirect. If server-side session requires logout, backend endpoint can be called here.
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            // Optionally call backend to clear server session:
            try {
              await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).catch(()=>null);
            } catch(e){}
            window.location.href = '/login';
          });
        }

        setActive();
      }

      async function initNav() {
        const token = localStorage.getItem('access_token');
        if (!token) {
          buildNav(null);
          return;
        }

        // Try to fetch user info to display name and validate token
        try {
          const res = await fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
          });
          if (!res.ok) {
            // token invalid/expired
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            buildNav(null);
            return;
          }
          const payload = await res.json();
          const user = payload.user || null;
          buildNav(user);
        } catch (err) {
          // network issue - show basic nav
          buildNav(null);
        }
      }

      // initialize and update active on navigation events
      initNav();
      window.addEventListener('popstate', setActive);
      document.addEventListener('DOMContentLoaded', setActive);
    })();
    </script>
</body>
</html>


